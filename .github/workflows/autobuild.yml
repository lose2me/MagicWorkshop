name: AutoBuild

on:
  workflow_dispatch:
  push:

permissions:
  contents: read

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup uv and Python 3.12
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true

      - name: Sync project dependencies
        run: uv sync --locked --no-dev

      - name: Build onefile executable
        run: >
          uv run --locked --with nuitka --with zstandard python -m nuitka main.py
          --onefile
          --windows-console-mode=disable
          --enable-plugin=pyside6
          --assume-yes-for-downloads
          --windows-icon-from-ico=logo.ico
          --output-dir=build/nuitka
          --output-filename=魔法少女工坊.exe

      - name: Ensure 7-Zip is available
        shell: pwsh
        run: |
          if (-not (Get-Command 7z -ErrorAction SilentlyContinue)) {
            choco install 7zip -y
          }
          7z i | Select-Object -First 5

      - name: Package release archive
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $exe = "build/nuitka/魔法少女工坊.exe"
          $tools = "tools"
          $stage = "build/package/MagicWorkshop"
          $archive = "build/package/MagicWorkshop.7z"

          if (!(Test-Path $exe)) { throw "Build output not found: $exe" }
          if (!(Test-Path $tools)) { throw "Tools folder not found: $tools" }

          New-Item -ItemType Directory -Force -Path $stage | Out-Null
          Get-ChildItem -Path $stage -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          Copy-Item -LiteralPath $exe -Destination (Join-Path $stage "魔法少女工坊.exe") -Force
          Copy-Item -LiteralPath $tools -Destination (Join-Path $stage "tools") -Recurse -Force

          $stagedExe = Join-Path $stage "魔法少女工坊.exe"
          $stagedTools = Join-Path $stage "tools"
          if (!(Test-Path $stagedExe)) { throw "Staged exe not found: $stagedExe" }
          if (!(Test-Path $stagedTools)) { throw "Staged tools folder not found: $stagedTools" }

          if (Test-Path $archive) { Remove-Item $archive -Force }
          Push-Location $stage
          7z a -t7z "..\\MagicWorkshop.7z" ".\\*" -m0=lzma2 -mx=9 -mfb=273 -md=128m -ms=on -mmt=on
          $exitCode = $LASTEXITCODE
          Pop-Location
          if ($exitCode -ne 0) { throw "7z failed with exit code $exitCode" }

      - name: Show artifact info
        shell: pwsh
        run: |
          $archive = "build/package/MagicWorkshop.7z"
          if (!(Test-Path $archive)) { throw "Archive not found: $archive" }
          $sizeMB = [math]::Round((Get-Item $archive).Length / 1MB, 2)
          Write-Host "Built: $archive"
          Write-Host "Size: ${sizeMB} MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MagicWorkshop-7z
          path: build/package/MagicWorkshop.7z
          if-no-files-found: error
